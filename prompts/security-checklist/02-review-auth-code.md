# 2. Review Auth Code

**AI often skips or oversimplifies authentication. Always review manually.**

Use these prompts to audit AI-generated auth code.

---

## Full Auth Code Review

```
Review this authentication code that was generated by AI:

[PASTE YOUR AUTH CODE]

Check for these common AI mistakes:

1. **Missing password hashing** - Is bcrypt/argon2 used? Salt included?
2. **Weak JWT implementation** - Is the secret strong? Expiry set? Algorithm specified?
3. **Session fixation** - Is session ID regenerated after login?
4. **Missing rate limiting** - Can someone brute force the login?
5. **Account enumeration** - Do error messages reveal if user exists?
6. **Insecure password reset** - Is the token single-use? Time-limited?
7. **Missing CSRF protection** - For cookie-based auth
8. **No logout invalidation** - Are tokens/sessions properly invalidated?

For each issue:
- Explain the vulnerability
- Show the attack scenario
- Provide the secure fix with code

Be thorough. Auth bugs are the most dangerous.
```

---

## Password Handling Audit

```
Audit this password handling code:

[PASTE PASSWORD-RELATED CODE]

Verify:
1. Passwords are hashed with bcrypt (cost factor 10+) or argon2
2. Salt is automatically generated (not hardcoded)
3. Password comparison uses timing-safe comparison
4. Original password is never logged or stored
5. Password requirements are enforced (length, complexity)
6. Password is validated before hashing (not empty, reasonable length)

Show me the secure implementation if anything is wrong.
```

---

## JWT Security Review

```
Review this JWT implementation:

[PASTE JWT CODE]

Check for:
1. **Algorithm confusion** - Is algorithm explicitly set (not "none")?
2. **Secret strength** - Is JWT_SECRET at least 256 bits?
3. **Expiry** - Is exp claim set? Is it reasonable (not days/weeks)?
4. **Refresh tokens** - Are they implemented for long sessions?
5. **Token storage** - Client-side: httpOnly cookies vs localStorage?
6. **Payload** - No sensitive data in payload (it's base64, not encrypted)
7. **Revocation** - Can tokens be invalidated before expiry?

Provide secure implementation for any issues.
```

---

## OAuth/Social Login Review

```
Review this OAuth implementation:

[PASTE OAUTH CODE]

Check for:
1. **State parameter** - Is it used to prevent CSRF?
2. **PKCE** - Is it implemented for public clients?
3. **Redirect URI validation** - Is it strictly validated?
4. **Token storage** - Are access/refresh tokens stored securely?
5. **Scope minimization** - Only requesting necessary permissions?
6. **Error handling** - No sensitive info in error responses?

Show fixes for any vulnerabilities.
```

---

## Session Management Review

```
Review this session management code:

[PASTE SESSION CODE]

Check for:
1. **Session ID entropy** - Is it cryptographically random?
2. **Session fixation** - Is ID regenerated after login?
3. **Secure cookies** - httpOnly, secure, sameSite flags set?
4. **Session expiry** - Absolute and idle timeouts?
5. **Logout** - Is session properly destroyed?
6. **Concurrent sessions** - Is there a limit?

Provide secure implementation for issues found.
```

---

## Auth Middleware Review

```
Review this auth middleware:

[PASTE MIDDLEWARE CODE]

Check for:
1. **All routes protected** - Are there unprotected routes that should be protected?
2. **Role-based access** - Is authorization checked, not just authentication?
3. **Token validation** - Is the full token validated (signature, expiry, issuer)?
4. **Error responses** - Do they leak information?
5. **Timing attacks** - Is comparison timing-safe?

Show the secure version.
```

---

## Quick Auth Checklist

```
Quick auth security check for my app:

Framework: [Next.js / Express / FastAPI / etc.]
Auth method: [JWT / Sessions / OAuth / etc.]
Auth library: [NextAuth / Passport / etc. or custom]

Run through this checklist:
[ ] Passwords hashed with bcrypt/argon2
[ ] JWT secret is strong (256+ bits)
[ ] Tokens expire in reasonable time
[ ] Rate limiting on login endpoint
[ ] Account lockout after failed attempts
[ ] Secure cookie flags set
[ ] CSRF protection enabled
[ ] Password reset tokens are single-use
[ ] Sessions invalidated on logout
[ ] No sensitive data in JWT payload

Just tell me pass/fail for each and what to fix.
```

---

## Common AI Auth Mistakes

### ❌ Storing plain passwords
```javascript
// AI sometimes generates this
await db.user.create({ password: req.body.password });
```

### ✅ Hash with bcrypt
```javascript
import bcrypt from 'bcrypt';
const hash = await bcrypt.hash(req.body.password, 12);
await db.user.create({ password: hash });
```

### ❌ Weak JWT secret
```javascript
// AI often uses weak secrets
const token = jwt.sign(payload, 'secret');
```

### ✅ Strong secret + explicit algorithm
```javascript
const token = jwt.sign(payload, process.env.JWT_SECRET, {
  algorithm: 'HS256',
  expiresIn: '15m'
});
```

### ❌ Revealing user existence
```javascript
// AI often does this
if (!user) return res.status(400).json({ error: 'User not found' });
if (!validPassword) return res.status(400).json({ error: 'Wrong password' });
```

### ✅ Generic error message
```javascript
if (!user || !validPassword) {
  return res.status(401).json({ error: 'Invalid credentials' });
}
```

---

*This prompt is part of the [VibeCheck Security Checklist](../README.md).*
